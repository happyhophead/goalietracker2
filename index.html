<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goalie Stats Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area input {
            display: none;
        }

        .stats-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card.team-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .games-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .games-table th,
        .games-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .games-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .games-table tr:hover {
            background: #f8f9ff;
        }

        .win {
            color: #10b981;
            font-weight: bold;
        }

        .loss {
            color: #ef4444;
            font-weight: bold;
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #764ba2;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .error {
            color: #ef4444;
            background: #fee;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success {
            color: #10b981;
            background: #d1fae5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .team-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .filter-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: transform 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèí Goalie Stats Tracker</h1>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('pdfInput').click()">
                <input type="file" id="pdfInput" accept=".pdf" multiple>
                <p style="font-size: 1.2em; margin-bottom: 10px;">üìÑ Click to Upload PDF Game Reports</p>
                <p style="color: #666;">Upload one or multiple PDF files</p>
            </div>
            <div id="statusMsg"></div>
        </div>

        <div id="loadingMsg" class="loading" style="display: none;">Loading games from database...</div>

        <div class="stats-container" id="statsContainer" style="display: none;">
            <h2>Overall Season Totals (All Teams)</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Games Played</div>
                    <div class="stat-value" id="totalGames">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Shots</div>
                    <div class="stat-value" id="totalShots">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Saves</div>
                    <div class="stat-value" id="totalSaves">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Goals Against</div>
                    <div class="stat-value" id="totalGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Save %</div>
                    <div class="stat-value" id="avgSavePercent">0.000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg RCE</div>
                    <div class="stat-value" id="avgRCE">0.00</div>
                </div>
            </div>

            <div id="teamStatsContainer"></div>

            <h2>Game History</h2>
            <div class="filter-buttons" id="filterButtons"></div>
            
            <div class="export-section">
                <button class="export-btn" onclick="exportToCSV('all')">üìä Export All Games to CSV</button>
                <button class="export-btn" onclick="exportToCSV('filtered')">üìä Export Filtered Games to CSV</button>
                <button class="export-btn" onclick="exportTeamStats()">üìà Export Team Stats to CSV</button>
            </div>

            <table class="games-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Team</th>
                        <th>Opponent</th>
                        <th>Result</th>
                        <th>Shots</th>
                        <th>Goals</th>
                        <th>Saves</th>
                        <th>Save %</th>
                        <th>RCE</th>
                    </tr>
                </thead>
                <tbody id="gamesTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let games = [];
        let currentFilter = 'all';

        // Load games on page load
        window.addEventListener('load', loadGames);

        async function loadGames() {
            document.getElementById('loadingMsg').style.display = 'block';
            
            try {
                const response = await fetch('/api/games');
                if (response.ok) {
                    const data = await response.json();
                    games = data.games || [];
                    if (games.length > 0) {
                        updateDisplay();
                    }
                }
            } catch (error) {
                console.error('Error loading games:', error);
            }
            
            document.getElementById('loadingMsg').style.display = 'none';
        }

        document.getElementById('pdfInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            document.getElementById('statusMsg').innerHTML = '<div class="loading">Processing PDFs...</div>';

            let newGamesCount = 0;
            for (let file of files) {
                try {
                    const text = await extractTextFromPDF(file);
                    const gameData = parseGameReport(text);
                    if (gameData) {
                        // Save to database
                        const response = await fetch('/api/games', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(gameData)
                        });

                        if (response.ok) {
                            const savedGame = await response.json();
                            games.push(savedGame);
                            newGamesCount++;
                        }
                    }
                } catch (error) {
                    document.getElementById('statusMsg').innerHTML = `<div class="error">Error processing ${file.name}: ${error.message}</div>`;
                }
            }

            if (newGamesCount > 0) {
                document.getElementById('statusMsg').innerHTML = `<div class="success">Successfully uploaded ${newGamesCount} game(s)!</div>`;
                updateDisplay();
            }

            e.target.value = '';
            setTimeout(() => {
                document.getElementById('statusMsg').innerHTML = '';
            }, 3000);
        });

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + ' ';
            }

            return fullText;
        }

        function parseGameReport(text) {
            const dateMatch = text.match(/([A-Za-z]+\s+\d{1,2}(?:st|nd|rd|th)?\s+\d{4})/);
            const teamMatch = text.match(/Team:\s*([^(]+?)(?:\s*\((?:Away|Home)\))?(?:\s+Opponent:)/);
            const opponentMatch = text.match(/Opponent:\s*([^(]+)/);
            const outcomeMatch = text.match(/Outcome:\s*(\d+-\d+)\s*(Win|Loss)/i);
            const shotsMatch = text.match(/Shots\s+Goals\s+Saves[^\d]*(\d+)\s+(\d+)\s+(\d+)\s+([\d.]+)\s+([\d.]+)/);

            if (!dateMatch || !teamMatch || !opponentMatch || !outcomeMatch || !shotsMatch) {
                return null;
            }

            return {
                date: dateMatch[1].trim(),
                team: teamMatch[1].trim(),
                opponent: opponentMatch[1].trim(),
                outcome: outcomeMatch[0].trim(),
                shots: parseInt(shotsMatch[1]),
                goals: parseInt(shotsMatch[2]),
                saves: parseInt(shotsMatch[3]),
                savePercent: parseFloat(shotsMatch[4]),
                rce: parseFloat(shotsMatch[5])
            };
        }

        function calculateStats(gamesList) {
            const totalGames = gamesList.length;
            const totalShots = gamesList.reduce((sum, game) => sum + game.shots, 0);
            const totalSaves = gamesList.reduce((sum, game) => sum + game.saves, 0);
            const totalGoals = gamesList.reduce((sum, game) => sum + game.goals, 0);
            const avgSavePercent = totalShots > 0 ? (totalSaves / totalShots) : 0;
            const avgRCE = totalGames > 0 ? gamesList.reduce((sum, game) => sum + game.rce, 0) / totalGames : 0;

            return { totalGames, totalShots, totalSaves, totalGoals, avgSavePercent, avgRCE };
        }

        function updateDisplay() {
            if (games.length === 0) return;

            document.getElementById('statsContainer').style.display = 'block';

            games.sort((a, b) => new Date(b.date) - new Date(a.date));

            const overallStats = calculateStats(games);
            document.getElementById('totalGames').textContent = overallStats.totalGames;
            document.getElementById('totalShots').textContent = overallStats.totalShots;
            document.getElementById('totalSaves').textContent = overallStats.totalSaves;
            document.getElementById('totalGoals').textContent = overallStats.totalGoals;
            document.getElementById('avgSavePercent').textContent = overallStats.avgSavePercent.toFixed(3);
            document.getElementById('avgRCE').textContent = overallStats.avgRCE.toFixed(2);

            const teamGames = {};
            games.forEach(game => {
                if (!teamGames[game.team]) {
                    teamGames[game.team] = [];
                }
                teamGames[game.team].push(game);
            });

            const teamStatsContainer = document.getElementById('teamStatsContainer');
            teamStatsContainer.innerHTML = '';

            Object.keys(teamGames).sort().forEach(teamName => {
                const teamStats = calculateStats(teamGames[teamName]);
                
                const teamSection = document.createElement('div');
                teamSection.className = 'team-section';
                teamSection.innerHTML = `
                    <h3>${teamName}</h3>
                    <div class="stats-grid">
                        <div class="stat-card team-card">
                            <div class="stat-label">Games Played</div>
                            <div class="stat-value">${teamStats.totalGames}</div>
                        </div>
                        <div class="stat-card team-card">
                            <div class="stat-label">Total Shots</div>
                            <div class="stat-value">${teamStats.totalShots}</div>
                        </div>
                        <div class="stat-card team-card">
                            <div class="stat-label">Total Saves</div>
                            <div class="stat-value">${teamStats.totalSaves}</div>
                        </div>
                        <div class="stat-card team-card">
                            <div class="stat-label">Total Goals Against</div>
                            <div class="stat-value">${teamStats.totalGoals}</div>
                        </div>
                        <div class="stat-card team-card">
                            <div class="stat-label">Save %</div>
                            <div class="stat-value">${teamStats.avgSavePercent.toFixed(3)}</div>
                        </div>
                        <div class="stat-card team-card">
                            <div class="stat-label">Avg RCE</div>
                            <div class="stat-value">${teamStats.avgRCE.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                teamStatsContainer.appendChild(teamSection);
            });

            const filterButtons = document.getElementById('filterButtons');
            filterButtons.innerHTML = '<button class="filter-btn active" onclick="filterGames(\'all\')">All Teams</button>';
            Object.keys(teamGames).sort().forEach(teamName => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = teamName;
                btn.onclick = () => filterGames(teamName);
                filterButtons.appendChild(btn);
            });

            updateGamesTable();
        }

        function filterGames(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((filter === 'all' && btn.textContent === 'All Teams') || 
                    btn.textContent === filter) {
                    btn.classList.add('active');
                }
            });

            updateGamesTable();
        }

        function updateGamesTable() {
            const tbody = document.getElementById('gamesTableBody');
            tbody.innerHTML = '';

            const filteredGames = currentFilter === 'all' ? games : games.filter(g => g.team === currentFilter);

            filteredGames.forEach(game => {
                const row = tbody.insertRow();
                const isWin = game.outcome.toLowerCase().includes('win');
                
                row.innerHTML = `
                    <td>${game.date}</td>
                    <td>${game.team}</td>
                    <td>${game.opponent}</td>
                    <td class="${isWin ? 'win' : 'loss'}">${game.outcome}</td>
                    <td>${game.shots}</td>
                    <td>${game.goals}</td>
                    <td>${game.saves}</td>
                    <td>${game.savePercent.toFixed(3)}</td>
                    <td>${game.rce.toFixed(2)}</td>
                `;
            });
        }

        function exportToCSV(type) {
            const gamesToExport = type === 'all' ? games : (currentFilter === 'all' ? games : games.filter(g => g.team === currentFilter));
            
            if (gamesToExport.length === 0) {
                alert('No games to export!');
                return;
            }

            let csv = 'Date,Team,Opponent,Outcome,Shots,Goals,Saves,Save %,RCE\n';
            
            gamesToExport.forEach(game => {
                csv += `"${game.date}","${game.team}","${game.opponent}","${game.outcome}",${game.shots},${game.goals},${game.saves},${game.savePercent.toFixed(3)},${game.rce.toFixed(2)}\n`;
            });

            downloadCSV(csv, `goalie_games_${type}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportTeamStats() {
            if (games.length === 0) {
                alert('No games to export!');
                return;
            }

            const teamGames = {};
            games.forEach(game => {
                if (!teamGames[game.team]) {
                    teamGames[game.team] = [];
                }
                teamGames[game.team].push(game);
            });

            let csv = 'Team,Games Played,Total Shots,Total Saves,Total Goals Against,Save %,Avg RCE\n';
            
            const overallStats = calculateStats(games);
            csv += `"ALL TEAMS (TOTAL)",${overallStats.totalGames},${overallStats.totalShots},${overallStats.totalSaves},${overallStats.totalGoals},${overallStats.avgSavePercent.toFixed(3)},${overallStats.avgRCE.toFixed(2)}\n`;
            
            Object.keys(teamGames).sort().forEach(teamName => {
                const teamStats = calculateStats(teamGames[teamName]);
                csv += `"${teamName}",${teamStats.totalGames},${teamStats.totalShots},${teamStats.totalSaves},${teamStats.totalGoals},${teamStats.avgSavePercent.toFixed(3)},${teamStats.avgRCE.toFixed(2)}\n`;
            });

            downloadCSV(csv, `goalie_team_stats_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>